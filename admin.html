<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EarnHub PRO Admin | Ultimate Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee; --dark: #1e1e2f; --success: #2ecc71;
            --danger: #e74c3c; --warning: #f1c40f; --bg: #f4f7fe;
        }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { margin: 0; background: var(--bg); display: flex; color: #333; }

        /* Sidebar */
        .sidebar { width: 260px; height: 100vh; background: var(--dark); color: white; position: fixed; padding: 25px; }
        .sidebar h2 { color: var(--primary); margin-bottom: 30px; }
        .nav-btn { width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: none; color: #fff; border-radius: 8px; margin-bottom: 10px; cursor: pointer; text-align: left; }
        .nav-btn:hover { background: var(--primary); }

        /* Main Content */
        .main { margin-left: 260px; width: calc(100% - 260px); padding: 40px; }
        .card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 25px; }
        
        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; border-top: 4px solid var(--primary); box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .stat-card h3 { font-size: 11px; color: #888; margin: 0; text-transform: uppercase; }
        .stat-card .val { font-size: 22px; font-weight: 700; }

        /* Search & Actions */
        .search-bar { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; }
        
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; color: #aaa; font-size: 11px; text-transform: uppercase; border-bottom: 1px solid #eee; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 13px; }

        .suspicious { background: #fff5f5; }
        .danger-tag { background: var(--danger); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; }

        .btn { border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 11px; margin-right: 5px; }
        .btn-pay { background: var(--success); color: white; }
        .btn-del { background: var(--danger); color: white; }
        .btn-edit { background: var(--warning); color: #000; }

        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div style="background:white; padding:40px; border-radius:20px; width:350px; text-align:center;">
        <h2>Admin Login</h2>
        <input type="password" id="adminPass" placeholder="Password" style="width:100%; padding:12px; margin:20px 0; border:1px solid #ddd; border-radius:8px;">
        <button class="btn-pay" style="width:100%; padding:12px; border:none; border-radius:8px; cursor:pointer;" onclick="checkAuth()">Login</button>
    </div>
</div>

<div class="sidebar">
    <h2>EarnHub PRO</h2>
    <button class="nav-btn" onclick="scrollToSec('reqSec')">Pending Requests</button>
    <button class="nav-btn" onclick="scrollToSec('userSec')">All Users</button>
    <button class="nav-btn" style="background:var(--danger); margin-top:20px;" onclick="resetSystem()">Weekly Reset All</button>
</div>

<div class="main">
    <div class="stats-grid">
        <div class="stat-card"><h3>Total Users</h3><div class="val" id="stUsers">0</div></div>
        <div class="stat-card" style="border-color:var(--warning)"><h3>Pending Reqs</h3><div class="val" id="stReqs">0</div></div>
        <div class="stat-card" style="border-color:var(--success)"><h3>Total Paid</h3><div class="val" id="stPaid">0</div></div>
        <div class="stat-card" style="border-color:var(--danger)"><h3>Fraud Alerts</h3><div class="val" id="stFraud">0</div></div>
    </div>

    <div class="card" id="reqSec">
        <h3>Withdrawal Requests</h3>
        <table>
            <thead>
                <tr>
                    <th>User / Speed</th>
                    <th>Points</th>
                    <th>Method</th>
                    <th>Details</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="reqBody"></tbody>
        </table>
    </div>

    <div class="card" id="userSec">
        <h3>User Management</h3>
        <input type="text" id="userSearch" class="search-bar" placeholder="Search by username..." onkeyup="searchUsers()">
        <table id="userTable">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Balance (CP)</th>
                    <th>Joined Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="userBody"></tbody>
        </table>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCBW21NQG7100ZQ_phXtVPiY-IWRzNCGu0",
        authDomain: "earn-money-600d9.firebaseapp.com",
        databaseURL: "https://earn-money-600d9-default-rtdb.firebaseio.com",
        projectId: "earn-money-600d9",
        storageBucket: "earn-money-600d9.firebasestorage.app",
        messagingSenderId: "12987052490",
        appId: "1:12987052490:web:4b349f2ad5a1812d9adf33"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function checkAuth() {
        if(document.getElementById("adminPass").value === "admin123") {
            document.getElementById("loginOverlay").style.display = "none";
            loadAll();
        } else { alert("Wrong Password!"); }
    }

    function loadAll() {
        // Stats & Requests
        db.ref('requests').on('value', snap => {
            const reqs = snap.val();
            document.getElementById("stReqs").innerText = snap.numChildren();
            let html = "";
            let fraudCount = 0;

            snap.forEach(child => {
                const r = child.val();
                db.ref('users/' + child.key).once('value', uSnap => {
                    const u = uSnap.val();
                    const hours = (new Date().getTime() - u.joinedAt) / (1000 * 60 * 60);
                    const speed = Math.round(r.points / (hours || 1));
                    const isFraud = speed > 600;
                    if(isFraud) fraudCount++;

                    const tr = document.createElement('tr');
                    if(isFraud) tr.className = "suspicious";
                    tr.innerHTML = `
                        <td><b>${child.key}</b><br><small>${speed} CP/hr</small> ${isFraud ? '<span class="danger-tag">ALERT</span>' : ''}</td>
                        <td>${r.points} CP</td>
                        <td>${r.method}</td>
                        <td>${r.details}</td>
                        <td>
                            <button class="btn btn-pay" onclick="payUser('${child.key}', ${r.points}, '${r.method}')">Paid</button>
                            <button class="btn btn-del" onclick="deleteReq('${child.key}')">Reject</button>
                        </td>`;
                    document.getElementById("reqBody").appendChild(tr);
                    document.getElementById("stFraud").innerText = fraudCount;
                });
            });
            document.getElementById("reqBody").innerHTML = "";
        });

        // User Management
        db.ref('users').on('value', snap => {
            document.getElementById("stUsers").innerText = snap.numChildren();
            let html = "";
            snap.forEach(child => {
                const u = child.val();
                html += `<tr>
                    <td>${child.key}</td>
                    <td><b>${u.points}</b></td>
                    <td>${new Date(u.joinedAt).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-edit" onclick="editPoints('${child.key}', ${u.points})">Edit</button>
                        <button class="btn btn-del" onclick="deleteUser('${child.key}')">Ban</button>
                    </td>
                </tr>`;
            });
            document.getElementById("userBody").innerHTML = html;
        });

        db.ref('payoutHistory').on('value', snap => { document.getElementById("stPaid").innerText = snap.numChildren(); });
    }

    function payUser(name, points, method) {
        if(confirm("Mark " + name + " as Paid?")) {
            db.ref('payoutHistory').push({ name, amount: points, method, date: new Date().toLocaleDateString() });
            db.ref('requests/' + name).remove();
        }
    }

    function editPoints(name, current) {
        const newVal = prompt("Enter new points for " + name, current);
        if(newVal != null) db.ref('users/' + name).update({ points: parseInt(newVal) });
    }

    function deleteUser(name) {
        if(confirm("Ban user " + name + "? This cannot be undone.")) {
            db.ref('users/' + name).remove();
            db.ref('requests/' + name).remove();
        }
    }

    function deleteReq(name) {
        if(confirm("Reject this request?")) db.ref('requests/' + name).remove();
    }

    function searchUsers() {
        const input = document.getElementById("userSearch").value.toLowerCase();
        const rows = document.getElementById("userBody").getElementsByTagName("tr");
        for (let row of rows) {
            const name = row.getElementsByTagName("td")[0].innerText.toLowerCase();
            row.style.display = name.includes(input) ? "" : "none";
        }
    }

    function resetSystem() {
        if(confirm("WEEKLY RESET: සියලුම පරිශීලකයින්ගේ ලකුණු 0 කර සතිය නැවත ආරම්භ කරනවාද?")) {
            db.ref('users').once('value', s => {
                s.forEach(u => db.ref('users/' + u.key).update({ points: 0, joinedAt: new Date().getTime() }));
                alert("All users reset!");
            });
        }
    }

    function scrollToSec(id) { document.getElementById(id).scrollIntoView({ behavior: 'smooth' }); }
</script>
</body>
</html>